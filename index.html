<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Customer App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4F46E5;
            --bg-color: #F3F4F6;
            --text-main: #1F2937;
            --danger: #EF4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Padauk', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; }

        /* --- LOGIN SCREEN --- */
        #loginScreen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; padding: 20px;
        }
        .auth-box {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
            text-align: center;
        }
        .auth-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 2px solid #E5E7EB; border-radius: 10px; outline: none;
        }
        .auth-btn {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-weight: 600; cursor: pointer;
        }
        .toggle-text { margin-top: 15px; font-size: 0.9rem; color: #6B7280; cursor: pointer; }
        .toggle-text span { color: var(--primary); font-weight: 600; }

        /* --- APP SCREEN --- */
        #appScreen { display: none; padding: 20px; padding-bottom: 80px; }
        
        header {
            max-width: 600px; margin: 0 auto 20px; display: flex;
            justify-content: space-between; align-items: center;
            background: white; padding: 15px 20px; border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .user-info { font-size: 0.8rem; color: #6B7280; text-align: right; }
        .logout-btn { color: #EF4444; cursor: pointer; font-size: 0.9rem; margin-left: 10px; }

        .add-btn {
            background: var(--primary); color: white; border: none;
            padding: 8px 16px; border-radius: 50px; font-size: 0.85rem;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }

        .container { max-width: 600px; margin: 0 auto; display: grid; gap: 15px; }
        
        .card {
            background: white; border-radius: 16px; padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid var(--primary);
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; }
        .card-info { 
            background: #F9FAFB; padding: 10px; border-radius: 8px; 
            font-size: 0.9rem; margin-bottom: 10px; white-space: pre-wrap; 
        }
        .card-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 0.9rem; }

        /* Modals & Dialogs */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-box { 
            background: white; width: 90%; max-width: 350px; padding: 25px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }

        .modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-full { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-weight:600; }
        
        /* Full Screen Loader */
        #loader { 
            position: fixed; inset: 0; background: white; z-index: 2000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }

        /* Skeleton Loading (Small placeholder while loading) */
        .skeleton-card {
            background: #e5e7eb; height: 100px; border-radius: 16px; 
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    </style>
</head>
<body>

    <div id="loader">
        <i class="fa-solid fa-circle-notch fa-spin fa-2x" style="color:var(--primary)"></i>
    </div>

    <div id="loginScreen">
        <div class="auth-box">
            <div class="auth-title" id="authTitle">အကောင့်ဝင်ပါ</div>
            <form id="authForm">
                <input type="email" id="email" class="auth-input" placeholder="Email" required>
                <input type="password" id="password" class="auth-input" placeholder="Password (6 လုံးအထက်)" required>
                <button type="submit" class="auth-btn" id="authBtn">Login</button>
            </form>
            <div class="toggle-text" onclick="toggleAuthMode()">
                <p id="toggleMsg">အကောင့်မရှိဘူးလား? <span>Register လုပ်မည်</span></p>
            </div>
            <p id="authError" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="appScreen">
        <header>
            <div>
                <h1 style="font-size:1.2rem; color:var(--primary);">Customer စာရင်း</h1>
                <div class="user-info">
                    <span id="userEmailDisplay"></span>
                    <i class="fa-solid fa-right-from-bracket logout-btn" onclick="confirmLogout()"></i>
                </div>
            </div>
            <button class="add-btn" onclick="openModal()">
                <i class="fa-solid fa-plus"></i> အသစ်
            </button>
        </header>

        <div class="container" id="cardContainer">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <h3 style="margin-bottom:15px; text-align:center;" id="modalTitle">စာရင်းထည့်မည်</h3>
            <form id="dataForm">
                <input type="hidden" id="docId">
                <input type="text" id="nameInput" class="modal-input" placeholder="အမည်" required>
                <textarea id="infoInput" class="modal-input" rows="3" placeholder="အချက်အလက်" required></textarea>
                <input type="url" id="linkInput" class="modal-input" placeholder="Link (Optional)">
                <div class="modal-btns">
                    <button type="button" class="btn-full" style="background:#F3F4F6; color:#333;" onclick="closeModal()">မလုပ်ပါ</button>
                    <button type="submit" class="btn-full" style="background:var(--primary); color:white;">သိမ်းမည်</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box" style="text-align: center;">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <h3 id="confirmMsg" style="margin-bottom: 20px; color: var(--text-main);">သေချာပြီလား?</h3>
            <div class="modal-btns">
                <button class="btn-full" style="background:#F3F4F6; color:#333;" onclick="closeConfirm()">မလုပ်ပါ</button>
                <button id="confirmYesBtn" class="btn-full" style="background:var(--primary); color:white;">သေချာသည်</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config 
        const firebaseConfig = {
          apiKey: "AIzaSyCyzN4nwSl9ReEwylS--PhwWb44l9WIWP0",
          authDomain: "c-list-6a134.firebaseapp.com",
          projectId: "c-list-6a134",
          storageBucket: "c-list-6a134.firebasestorage.app",
          messagingSenderId: "456688105100",
          appId: "1:456688105100:web:88f78e0ab2aa3cc38e2da9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SPEED BOOST: ENABLE OFFLINE PERSISTENCE ---
        // This makes data load instantly from phone cache
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Multiple tabs open, persistence can only be enabled in one tab at a a time.');
            } else if (err.code == 'unimplemented') {
                console.log('The current browser does not support all of the features required to enable persistence');
            }
        });

        let currentUser = null;
        let isRegisterMode = false;
        let unsubscribe = null;
        let pendingAction = null;

        const loader = document.getElementById('loader');
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const container = document.getElementById('cardContainer');
        const confirmModal = document.getElementById('confirmModal');

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('userEmailDisplay').innerText = user.email;
                
                // SPEED OPTIMIZATION:
                // Show App Screen IMMEDIATELY, don't wait for data
                loader.style.display = 'none'; 
                loginScreen.style.display = 'none';
                appScreen.style.display = 'block';
                
                loadUserData(user.uid); 
            } else {
                loginScreen.style.display = 'flex';
                appScreen.style.display = 'none';
                container.innerHTML = '';
                if(unsubscribe) unsubscribe();
                loader.style.display = 'none';
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.style.display = 'flex';
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('authError');
            errorMsg.innerText = "";

            try {
                if (isRegisterMode) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
                // Loader will be hidden by onAuthStateChanged
            } catch (error) {
                loader.style.display = 'none';
                let msg = "Something went wrong.";
                if(error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') msg = "Email သို့မဟုတ် Password မှားနေပါသည်";
                if(error.code === 'auth/user-not-found') msg = "အကောင့်မရှိပါ";
                errorMsg.innerText = msg;
            }
        });

        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('authTitle').innerText = isRegisterMode ? "အကောင့်သစ်ဖွင့်မည်" : "အကောင့်ဝင်ပါ";
            document.getElementById('authBtn').innerText = isRegisterMode ? "Register" : "Login";
            document.getElementById('toggleMsg').innerHTML = isRegisterMode 
                ? "အကောင့်ရှိပြီးလား? <span>Login ဝင်မည်</span>" 
                : "အကောင့်မရှိဘူးလား? <span>Register လုပ်မည်</span>";
        }

        // --- CONFIRMATION DIALOG LOGIC ---
        window.confirmLogout = () => {
            document.getElementById('confirmMsg').innerText = "Logout လုပ်မှာသေချာလား?";
            pendingAction = () => signOut(auth);
            confirmModal.classList.add('active');
        }

        window.requestDelete = (id) => {
            document.getElementById('confirmMsg').innerText = "ဒီစာရင်းကို ဖျက်မှာသေချာလား?";
            pendingAction = async () => {
                await deleteDoc(doc(db, "customers", id));
            };
            confirmModal.classList.add('active');
        }

        document.getElementById('confirmYesBtn').addEventListener('click', () => {
            if (pendingAction) pendingAction();
            window.closeConfirm();
        });

        window.closeConfirm = () => {
            confirmModal.classList.remove('active');
            pendingAction = null;
        }

        // --- DATA LOGIC ---
        function loadUserData(uid) {
            const q = query(collection(db, "customers"), where("uid", "==", uid));

            // onSnapshot triggers instantly with cached data first (if enabled)
            unsubscribe = onSnapshot(q, (snapshot) => {
                
                let docs = [];
                snapshot.forEach((doc) => {
                    docs.push({ id: doc.id, ...doc.data() });
                });

                // Client-side Sort
                docs.sort((a, b) => b.createdAt - a.createdAt);

                container.innerHTML = '';
                if (docs.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#888; margin-top:50px;">မှတ်တမ်းမရှိသေးပါ</p>';
                } else {
                    docs.forEach(item => renderCard(item.id, item));
                }
            });
        }

        function renderCard(id, data) {
            const card = document.createElement('div');
            card.className = 'card';
            const linkHtml = data.link ? `<a href="${data.link}" target="_blank" style="color:var(--primary); font-size:0.9rem; text-decoration:none;"><i class="fa-solid fa-link"></i> Link</a>` : '';
            
            card.innerHTML = `
                <div class="card-name">${data.name}</div>
                <div class="card-info">${data.info}</div>
                ${linkHtml}
                <div class="card-actions">
                    <button class="action-btn" style="color:var(--primary)" onclick="prepEdit('${id}', '${data.name}', \`${data.info}\`, '${data.link || ''}')">
                        <i class="fa-solid fa-pen"></i> ပြင်
                    </button>
                    <button class="action-btn" style="color:#EF4444" onclick="requestDelete('${id}')">
                        <i class="fa-solid fa-trash"></i> ဖျက်
                    </button>
                </div>
            `;
            container.appendChild(card);
        }

        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;

            const id = document.getElementById('docId').value;
            const name = document.getElementById('nameInput').value;
            const info = document.getElementById('infoInput').value;
            const link = document.getElementById('linkInput').value;

            const data = {
                uid: currentUser.uid,
                name: name,
                info: info,
                link: link,
                createdAt: Date.now()
            };

            try {
                closeModal();
                if(id) {
                    const docRef = doc(db, "customers", id);
                    await updateDoc(docRef, { name, info, link });
                } else {
                    await addDoc(collection(db, "customers"), data);
                }
            } catch (err) {
                console.error("Error:", err);
                alert("Operation failed");
            }
        });

        window.prepEdit = (id, name, info, link) => {
            document.getElementById('docId').value = id;
            document.getElementById('nameInput').value = name;
            document.getElementById('infoInput').value = info;
            document.getElementById('linkInput').value = link;
            document.getElementById('modalTitle').innerText = "ပြင်ဆင်မည်";
            document.getElementById('modal').classList.add('active');
        }

        window.openModal = () => {
            document.getElementById('dataForm').reset();
            document.getElementById('docId').value = "";
            document.getElementById('modalTitle').innerText = "စာရင်းထည့်မည်";
            document.getElementById('modal').classList.add('active');
        }

        window.closeModal = () => {
            document.getElementById('modal').classList.remove('active');
        }
    </script>
</body>
</html>
