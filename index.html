<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Customer App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --bg-color: #F3F4F6;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Padauk', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; }

        /* --- LOGIN SCREEN --- */
        #loginScreen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; padding: 20px;
        }
        .auth-box {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
            text-align: center;
        }
        .auth-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 2px solid #E5E7EB; border-radius: 10px; outline: none;
        }
        .auth-btn {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-weight: 600; cursor: pointer;
        }
        .toggle-text { margin-top: 15px; font-size: 0.9rem; color: #6B7280; cursor: pointer; }
        .toggle-text span { color: var(--primary); font-weight: 600; }

        /* --- APP SCREEN --- */
        #appScreen { display: none; padding: 20px; padding-bottom: 80px; }
        
        /* Modern Header */
        header {
            max-width: 600px; margin: 0 auto 20px; 
            background: white; padding: 15px 20px; border-radius: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }

        .profile-area {
            display: flex; align-items: center; gap: 12px; cursor: pointer;
            padding: 5px; border-radius: 10px; transition: 0.2s;
        }
        .profile-area:active { background: #f9fafb; }

        /* Profile Avatar */
        .avatar {
            width: 45px; height: 45px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-weight: 700; font-size: 1.2rem; text-transform: uppercase;
            overflow: hidden; border: 2px solid #EEF2FF; object-fit: cover;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .profile-info h2 { font-size: 1rem; font-weight: 600; line-height: 1.2; color: var(--text-main); }
        .profile-info p { font-size: 0.8rem; color: var(--text-sub); }

        /* FIXED LOGOUT ICON (Perfect Circle) */
        .logout-icon { 
            color: var(--danger); cursor: pointer; 
            width: 40px; height: 40px; 
            border-radius: 50%; background: #FEF2F2;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s; flex-shrink: 0;
        }
        .logout-icon:active { transform: scale(0.9); }

        /* Search Bar */
        .search-container {
            position: relative; margin-bottom: 5px;
        }
        .search-input {
            width: 100%; padding: 12px 15px 12px 40px;
            border: 2px solid #E5E7EB; border-radius: 12px;
            font-size: 0.95rem; outline: none; transition: border-color 0.2s;
            background: #F9FAFB;
        }
        .search-input:focus { border-color: var(--primary); background: white; }
        .search-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: #9CA3AF;
        }

        /* Floating Add Button */
        .add-btn-float {
            position: fixed; bottom: 25px; right: 25px;
            background: var(--primary); color: white;
            width: 55px; height: 55px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            cursor: pointer; z-index: 900; transition: transform 0.2s;
            border: none;
        }
        .add-btn-float:active { transform: scale(0.9); }

        .container { max-width: 600px; margin: 0 auto; display: grid; gap: 15px; }
        
        /* Card Design */
        .card {
            background: white; border-radius: 16px; padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid var(--primary);
            position: relative; animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; }
        .card-info { 
            background: #F9FAFB; padding: 10px; border-radius: 8px; 
            font-size: 0.9rem; margin-bottom: 10px; white-space: pre-wrap; 
        }
        .card-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 0.9rem; }

        /* Modals & Dialogs */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-box { 
            background: white; width: 90%; max-width: 350px; padding: 25px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }

        .modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-full { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-weight:600; }
        
        /* Profile Edit Styles */
        .profile-edit-img {
            width: 80px; height: 80px; border-radius: 50%; background: #eee;
            margin: 0 auto 15px; display: flex; justify-content: center; align-items: center;
            overflow: hidden; cursor: pointer; border: 2px dashed #ccc; position: relative;
        }
        .profile-edit-img img { width: 100%; height: 100%; object-fit: cover; }
        .profile-edit-icon { font-size: 1.5rem; color: #888; }
        
        /* Loading */
        #loader { 
            position: fixed; inset: 0; background: white; z-index: 2000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        
        .empty-msg { text-align:center; color:#9CA3AF; margin-top:40px; }

    </style>
</head>
<body>

    <div id="loader">
        <i class="fa-solid fa-circle-notch fa-spin fa-2x" style="color:var(--primary)"></i>
    </div>

    <div id="loginScreen">
        <div class="auth-box">
            <div class="auth-title" id="authTitle">အကောင့်ဝင်ပါ</div>
            <form id="authForm">
                <input type="email" id="email" class="auth-input" placeholder="Email" required>
                <input type="password" id="password" class="auth-input" placeholder="Password (6 လုံးအထက်)" required>
                <button type="submit" class="auth-btn" id="authBtn">Login</button>
            </form>
            <div class="toggle-text" onclick="toggleAuthMode()">
                <p id="toggleMsg">အကောင့်မရှိဘူးလား? <span>Register လုပ်မည်</span></p>
            </div>
            <p id="authError" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="appScreen">
        <header>
            <div class="header-top">
                <div class="profile-area" onclick="openProfileModal()">
                    <div class="avatar" id="headerAvatar">U</div>
                    <div class="profile-info">
                        <h2 id="headerName">User</h2>
                        <p id="headerEmail">user@email.com</p>
                    </div>
                    <i class="fa-solid fa-pen-to-square" style="font-size: 0.8rem; color: #aaa;"></i>
                </div>
                <div class="logout-icon" onclick="confirmLogout()">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </div>
            </div>

            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Search keywords..." onkeyup="filterData()">
            </div>
        </header>

        <div class="container" id="cardContainer">
            </div>

        <button class="add-btn-float" onclick="openModal()">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <h3 style="margin-bottom:15px; text-align:center;" id="modalTitle">စာရင်းထည့်မည်</h3>
            <form id="dataForm">
                <input type="hidden" id="docId">
                <input type="text" id="nameInput" class="modal-input" placeholder="အမည်" required>
                <textarea id="infoInput" class="modal-input" rows="3" placeholder="အချက်အလက်" required></textarea>
                <input type="url" id="linkInput" class="modal-input" placeholder="Link (Optional)">
                <div class="modal-btns">
                    <button type="button" class="btn-full" style="background:#F3F4F6; color:#333;" onclick="closeModal()">မလုပ်ပါ</button>
                    <button type="submit" class="btn-full" style="background:var(--primary); color:white;">သိမ်းမည်</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="profileModal">
        <div class="modal-box">
            <h3 style="margin-bottom:15px; text-align:center;">Profile ပြင်မည်</h3>
            
            <div class="profile-edit-img" onclick="document.getElementById('fileInput').click()">
                <img id="previewImg" src="" style="display:none;">
                <div id="previewIcon" class="profile-edit-icon"><i class="fa-solid fa-camera"></i></div>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
            
            <div style="margin-bottom:10px;">
                <label style="font-size:0.8rem; font-weight:600; color:#666;">အမည်</label>
                <input type="text" id="editProfileName" class="modal-input" placeholder="Name">
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-size:0.8rem; font-weight:600; color:#666;">Email (ပြောင်းမရပါ)</label>
                <input type="text" id="editProfileEmail" class="modal-input" style="background:#f3f4f6; color:#888;" disabled>
            </div>

            <div class="modal-btns">
                <button class="btn-full" style="background:#F3F4F6; color:#333;" onclick="closeProfileModal()">မလုပ်ပါ</button>
                <button class="btn-full" style="background:var(--primary); color:white;" onclick="saveProfile()">သိမ်းမည်</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box" style="text-align: center;">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <h3 id="confirmMsg" style="margin-bottom: 20px; color: var(--text-main);">သေချာပြီလား?</h3>
            <div class="modal-btns">
                <button class="btn-full" style="background:#F3F4F6; color:#333;" onclick="closeConfirm()">မလုပ်ပါ</button>
                <button id="confirmYesBtn" class="btn-full" style="background:var(--primary); color:white;">သေချာသည်</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- SECURITY: OBFUSCATED CONFIG (Base64 Encoded) ---
        // မိတ်ဆွေ၏ Key များကို ဝှက်ထားသော အပိုင်း
        const _0x1 = (s) => atob(s);
        const _config = {
            _k: "QUl6YVN5Q3l6TjRud1NsOVJlRXd5bFMtLVB1d1diNDRsOVdJV1Aw",
            _d: "Yy1saXN0LTZhMTM0LmZpcmViYXNlYXBwLmNvbQ==",
            _p: "Yy1saXN0LTZhMTM0",
            _s: "Yy1saXN0LTZhMTM0LmZpcmViYXNlc3RvcmFnZS5hcHA=",
            _m: "NDU2Njg4MTA1MTAw",
            _a: "MTo0NTY2ODgxMDUxMDA6d2ViOjg4Zjc4ZTBhYjJhYTNjYzM4ZTJkYTk="
        };

        const firebaseConfig = {
            apiKey: _0x1(_config._k),
            authDomain: _0x1(_config._d),
            projectId: _0x1(_config._p),
            storageBucket: _0x1(_config._s),
            messagingSenderId: _0x1(_config._m),
            appId: _0x1(_config._a)
        };
        // ----------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable Offline Persistence (Instant Load)
        enableIndexedDbPersistence(db).catch((err) => console.log("Persistence:", err.code));

        let currentUser = null;
        let isRegisterMode = false;
        let unsubscribe = null;
        let pendingAction = null;
        let allCustomers = [];
        let tempBase64Img = null;

        const loader = document.getElementById('loader');
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const container = document.getElementById('cardContainer');
        const confirmModal = document.getElementById('confirmModal');
        const profileModal = document.getElementById('profileModal');

        // --- AUTH & INITIALIZATION ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // Initial UI Setup
                document.getElementById('headerEmail').innerText = user.email;
                document.getElementById('editProfileEmail').value = user.email;
                
                // Show App Immediately (Optimistic UI)
                loader.style.display = 'none'; 
                loginScreen.style.display = 'none';
                appScreen.style.display = 'block';

                // Load Data & Profile in background
                loadUserProfile(user);
                loadUserData(user.uid); 
            } else {
                loginScreen.style.display = 'flex';
                appScreen.style.display = 'none';
                container.innerHTML = '';
                if(unsubscribe) unsubscribe();
                loader.style.display = 'none';
            }
        });

        // --- PROFILE LOGIC ---
        async function loadUserProfile(user) {
            try {
                const userDocRef = doc(db, "user_profiles", user.uid);
                const userSnap = await getDoc(userDocRef);
                
                let displayName = user.displayName || user.email.split('@')[0];
                let photoData = null;

                if (userSnap.exists()) {
                    const data = userSnap.data();
                    if(data.name) displayName = data.name;
                    if(data.photoBase64) photoData = data.photoBase64;
                }

                document.getElementById('headerName').innerText = displayName;
                const avatarEl = document.getElementById('headerAvatar');
                
                if (photoData) {
                    avatarEl.innerHTML = `<img src="${photoData}">`;
                    avatarEl.style.background = "none";
                    avatarEl.style.border = "2px solid #fff";
                } else {
                    avatarEl.innerHTML = displayName.charAt(0).toUpperCase();
                    avatarEl.style.background = "var(--primary)";
                    avatarEl.style.border = "none";
                }
            } catch (e) { console.log("Profile Load Error", e); }
        }

        window.openProfileModal = () => {
            document.getElementById('editProfileName').value = document.getElementById('headerName').innerText;
            tempBase64Img = null;
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('previewIcon').style.display = 'block';
            profileModal.classList.add('active');
        }

        window.closeProfileModal = () => { profileModal.classList.remove('active'); }

        window.handleImageSelect = (event) => {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 1024 * 1024) { alert("ပုံဆိုဒ် 1MB အောက် ရွေးပါ"); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 200; 
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        tempBase64Img = canvas.toDataURL('image/jpeg', 0.7);
                        const preview = document.getElementById('previewImg');
                        preview.src = tempBase64Img;
                        preview.style.display = 'block';
                        document.getElementById('previewIcon').style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        window.saveProfile = async () => {
            if(!currentUser) return;
            const newName = document.getElementById('editProfileName').value;
            if(!newName) return alert("နာမည်ထည့်ပါ");

            document.getElementById('headerName').innerText = newName;
            
            const updateData = { name: newName };
            if (tempBase64Img) {
                updateData.photoBase64 = tempBase64Img;
                const avatarEl = document.getElementById('headerAvatar');
                avatarEl.innerHTML = `<img src="${tempBase64Img}">`;
            }
            closeProfileModal();

            try {
                await setDoc(doc(db, "user_profiles", currentUser.uid), updateData, { merge: true });
                await updateProfile(currentUser, { displayName: newName });
            } catch (error) { console.error(error); }
        }

        // --- LOGIN/REGISTER ---
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.style.display = 'flex';
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('authError');
            errorMsg.innerText = "";

            try {
                if (isRegisterMode) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (error) {
                loader.style.display = 'none';
                let msg = "Error occurred.";
                if(error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') msg = "Email သို့မဟုတ် Password မှားနေပါသည်";
                if(error.code === 'auth/user-not-found') msg = "အကောင့်မရှိပါ";
                if(error.code === 'auth/email-already-in-use') msg = "ဒီ Email ရှိပြီးသားပါ";
                if(error.code === 'auth/weak-password') msg = "Password ၆ လုံးအထက် ပေးပါ";
                errorMsg.innerText = msg;
            }
        });

        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('authTitle').innerText = isRegisterMode ? "အကောင့်သစ်ဖွင့်မည်" : "အကောင့်ဝင်ပါ";
            document.getElementById('authBtn').innerText = isRegisterMode ? "Register" : "Login";
            document.getElementById('toggleMsg').innerHTML = isRegisterMode 
                ? "အကောင့်ရှိပြီးလား? <span>Login ဝင်မည်</span>" 
                : "အကောင့်မရှိဘူးလား? <span>Register လုပ်မည်</span>";
        }

        // --- DIALOGS ---
        window.confirmLogout = () => {
            document.getElementById('confirmMsg').innerText = "Logout လုပ်မှာသေချာလား?";
            pendingAction = () => signOut(auth);
            confirmModal.classList.add('active');
        }

        window.requestDelete = (id) => {
            document.getElementById('confirmMsg').innerText = "ဒီစာရင်းကို ဖျက်မှာသေချာလား?";
            pendingAction = async () => { await deleteDoc(doc(db, "customers", id)); };
            confirmModal.classList.add('active');
        }

        document.getElementById('confirmYesBtn').addEventListener('click', () => {
            if (pendingAction) pendingAction();
            window.closeConfirm();
        });

        window.closeConfirm = () => { confirmModal.classList.remove('active'); pendingAction = null; }

        // --- DATA LOGIC ---
        function loadUserData(uid) {
            const q = query(collection(db, "customers"), where("uid", "==", uid));
            unsubscribe = onSnapshot(q, (snapshot) => {
                allCustomers = [];
                snapshot.forEach((doc) => {
                    allCustomers.push({ id: doc.id, ...doc.data() });
                });
                allCustomers.sort((a, b) => b.createdAt - a.createdAt);
                renderList(allCustomers);
            });
        }

        window.filterData = () => {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allCustomers.filter(item => 
                item.name.toLowerCase().includes(keyword) || 
                item.info.toLowerCase().includes(keyword)
            );
            renderList(filtered);
        }

        function renderList(dataList) {
            container.innerHTML = '';
            if (dataList.length === 0) {
                container.innerHTML = '<div class="empty-msg"><i class="fa-solid fa-box-open" style="font-size:2rem; margin-bottom:10px;"></i><p>စာရင်းမတွေ့ပါ</p></div>';
            } else {
                dataList.forEach(item => renderCard(item.id, item));
            }
        }

        function renderCard(id, data) {
            const card = document.createElement('div');
            card.className = 'card';
            const linkHtml = data.link ? `<a href="${data.link}" target="_blank" style="color:var(--primary); font-size:0.9rem; text-decoration:none;"><i class="fa-solid fa-link"></i> Link</a>` : '';
            
            card.innerHTML = `
                <div class="card-name">${data.name}</div>
                <div class="card-info">${data.info}</div>
                ${linkHtml}
                <div class="card-actions">
                    <button class="action-btn" style="color:var(--primary)" onclick="prepEdit('${id}', '${data.name}', \`${data.info}\`, '${data.link || ''}')">
                        <i class="fa-solid fa-pen"></i> ပြင်
                    </button>
                    <button class="action-btn" style="color:#EF4444" onclick="requestDelete('${id}')">
                        <i class="fa-solid fa-trash"></i> ဖျက်
                    </button>
                </div>
            `;
            container.appendChild(card);
        }

        // --- ADD / EDIT ---
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;

            const id = document.getElementById('docId').value;
            const name = document.getElementById('nameInput').value;
            const info = document.getElementById('infoInput').value;
            const link = document.getElementById('linkInput').value;

            const data = {
                uid: currentUser.uid,
                name: name,
                info: info,
                link: link,
                createdAt: Date.now()
            };

            try {
                closeModal();
                if(id) {
                    const docRef = doc(db, "customers", id);
                    await updateDoc(docRef, { name, info, link });
                } else {
                    await addDoc(collection(db, "customers"), data);
                }
            } catch (err) { console.error("Error:", err); alert("Operation failed"); }
        });

        window.prepEdit = (id, name, info, link) => {
            document.getElementById('docId').value = id;
            document.getElementById('nameInput').value = name;
            document.getElementById('infoInput').value = info;
            document.getElementById('linkInput').value = link;
            document.getElementById('modalTitle').innerText = "ပြင်ဆင်မည်";
            document.getElementById('modal').classList.add('active');
        }

        window.openModal = () => {
            document.getElementById('dataForm').reset();
            document.getElementById('docId').value = "";
            document.getElementById('modalTitle').innerText = "စာရင်းထည့်မည်";
            document.getElementById('modal').classList.add('active');
        }

        window.closeModal = () => { document.getElementById('modal').classList.remove('active'); }
    </script>
</body>
</html>
